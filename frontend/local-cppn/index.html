<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    <script type="module">
        import { pipeline } from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2';
    </script> -->
  <title>CPPN Demo</title>


</head>
<body>

  <h1>CPPN Interactive Demo</h1>
  <div class="container">
    <div class="controls">
      <h2>Input Scales</h2>
      <label for="inputX">X:</label>
      <input type="number" id="inputX" step="1" value="10">
      <br>
      <label for="inputY">Y:</label>
      <input type="number" id="inputY" step="1" value="10">
      <br><br>
      <label for="gridResolution">Grid Resolution (N):</label>
      <input type="range" id="gridResolution" min="1" max="1024" step="16" value="256">
      <span id="gridResolutionValue">256</span>
      <br><br>
      <button id="newBtn">New CPPN</button>
      <p class="output">Output: <span id="outputDisplay">---</span></p>
    </div>
    <canvas id="cppnCanvas" width="600" height="400"></canvas>
    <canvas id="imageCanvas" width="1024" height="1024"></canvas>
    <!-- <img id="imageCanvas" src="" alt="CPPN Image" width="1024" height="1024"> -->
    <label for="targetPrompt">Target Prompt:</label>
<input type="text" id="targetPrompt" value="A vibrant fractal pattern">
<br>
<button id="compareBtn">Compare Image</button>
<p id="similarityScore">Similarity: ---</p>

  </div>


  <script type="module">
    tf.setBackend('webgl');
    console.log(tf.getBackend());
    

    import { renderCPPNImage, setupGridRenderer, generateGrid, initializeCanvasControls } from './renderer.js';
    import { initializeCPPN, evaluate } from './cppn.js';
    //import {loadCLIP, evaluateImageSimilarity} from './clip.js';

    const gridResolutionValue = document.getElementById('gridResolutionValue');
    const gridResolutionInput = document.getElementById('gridResolution');
    const newBtn = document.getElementById('newBtn');

    //loadCLIP();
    
    function update(){
        // Initialize the CPPN
        const cppn = initializeCPPN(3, [3, 2], 3);

        // Initialize canvas interactions
        initializeCanvasControls();
        
        // Set up image renderer with the initialized CPPN
        setupGridRenderer(gridResolutionInput, gridResolutionValue, newBtn, cppn);
        
        
        const res = parseInt(gridResolutionValue.textContent);
        // Render the initial image
        renderCPPNImage(cppn, res);
        
        
        // Evaluate the CPPN on the initial input
        // Read input range values
        const inputX = parseFloat(document.getElementById('inputX').value);
        const inputY = parseFloat(document.getElementById('inputY').value);
    
        // Generate grid tensors
        const { X, Y, R } = generateGrid(inputX, inputY, res);
    
        // Create input tensors for the CPPN (stacked inputs)
        const inputTensors = [X.flatten(), Y.flatten(), R.flatten()];
    
        // Evaluate the CPPN to get outputs
        const outputs = evaluate(cppn, inputTensors);

        
        outputDisplay.textContent = outputs;
        
    }
    update();

    newBtn.addEventListener('click', update);

    document.getElementById("compareBtn").addEventListener("click", evaluateImageSimilarity);

    
  </script>
  
</body>
</html>
